# Agent å·¥å…·è°ƒç”¨æ–‡æ¡£

## æ¦‚è¿°

Agent å·¥å…·è°ƒç”¨ç³»ç»ŸåŸºäº **LLM Function Calling** æœºåˆ¶ï¼Œå…è®¸ LLM æ ¹æ®ç”¨æˆ·æ„å›¾è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å·¥å…·å¹¶æ‰§è¡Œã€‚ç³»ç»Ÿæ”¯æŒæµå¼å“åº”ï¼Œå¯ä»¥å®æ—¶è¿”å›å·¥å…·æ‰§è¡Œç»“æœå’Œ LLM ç”Ÿæˆçš„å›ç­”ã€‚

### è°ƒç”¨æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ LLM åˆ†ææ„å›¾ â†’ é€‰æ‹©å·¥å…· â†’ è°ƒç”¨å·¥å…· â†’ è¿”å›ç»“æœ â†’ LLM æ•´åˆç»“æœ â†’ ç”Ÿæˆæœ€ç»ˆå›ç­”
```

### å“åº”ç±»å‹

Agent æ¨¡å¼ä¸‹çš„æµå¼å“åº”åŒ…å«ä»¥ä¸‹ç±»å‹ï¼š

- `tool_result`: å·¥å…·æ‰§è¡ŒæˆåŠŸçš„ç»“æœ
- `tool_error`: å·¥å…·æ‰§è¡Œå¤±è´¥çš„é”™è¯¯ä¿¡æ¯
- `mindmap_content`: æ€ç»´è„‘å›¾ç”Ÿæˆè¿‡ç¨‹ä¸­çš„å†…å®¹å—ï¼ˆæµå¼ï¼‰
- `response`: LLM ç”Ÿæˆçš„æœ€ç»ˆå›ç­”å†…å®¹ï¼ˆæµå¼ï¼‰
- `error`: ç³»ç»Ÿçº§é”™è¯¯

### å·¥ä½œæ¨¡å¼

- **Agent æ¨¡å¼**: å¼€å¯åï¼ŒLLM å¯ä»¥è‡ªåŠ¨è°ƒç”¨å·¥å…·
- **ç®€å•æ¨¡å¼**: å…³é—­åï¼Œåªèƒ½è¿›è¡Œæ™®é€šå¯¹è¯ï¼Œä¸è°ƒç”¨å·¥å…·

## å½“å‰å¯ç”¨å·¥å…·

### 1. list_documentsï¼ˆåˆ—å‡ºæ–‡æ¡£ï¼‰

**å·¥å…·åç§°**: `list_documents`

**å·¥å…·æè¿°**: åˆ—å‡ºå½“å‰å¯¹è¯ä¸­çš„æ‰€æœ‰æ–‡æ¡£ï¼ŒåŒ…æ‹¬æ–‡ä»¶åã€ä¸Šä¼ æ—¶é—´ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚

**å‚æ•°è¯´æ˜**:

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|---------|--------|------|
| `conversation_id` | string | âœ… æ˜¯ | - | å¯¹è¯IDï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’ï¼‰ |

**å‚æ•°ç¤ºä¾‹**:

```json
{
  "conversation_id": "abc123-def456-ghi789"
}
```

**è¿”å›å€¼**:

æˆåŠŸæ—¶:
```json
{
  "status": "success",
  "message": "æˆåŠŸåˆ—å‡º 3 ä¸ªæ–‡æ¡£",
  "result": "å½“å‰å¯¹è¯å…±æœ‰ 3 ä¸ªæ–‡æ¡£ï¼š\n1. æ–‡æ¡£1.pdf (2.5 MB) - å·²å®Œæˆ\n   ä¸Šä¼ æ—¶é—´: 2024-01-01 10:00:00\n2. æ–‡æ¡£2.docx (1.2 MB) - å¤„ç†ä¸­\n   ä¸Šä¼ æ—¶é—´: 2024-01-01 11:00:00\n3. æ–‡æ¡£3.pptx (5.8 MB) - å·²å®Œæˆ\n   ä¸Šä¼ æ—¶é—´: 2024-01-01 12:00:00",
  "documents": [
    {
      "file_id": "doc1",
      "filename": "æ–‡æ¡£1.pdf",
      "upload_time": "2024-01-01 10:00:00",
      "status": "completed",
      "file_type": "pdf",
      "file_size": 2621440
    },
    ...
  ],
  "document_count": 3
}
```

æ— æ–‡æ¡£æ—¶:
```json
{
  "status": "success",
  "message": "å½“å‰å¯¹è¯ä¸­æ²¡æœ‰æ–‡æ¡£",
  "documents": [],
  "document_count": 0
}
```

å¤±è´¥æ—¶:
```json
{
  "status": "error",
  "message": "åˆ—å‡ºæ–‡æ¡£æ—¶å‡ºé”™: é”™è¯¯ä¿¡æ¯",
  "error": "è¯¦ç»†é”™è¯¯",
  "documents": [],
  "document_count": 0
}
```

**é€Ÿç‡é™åˆ¶**: æ¯åˆ†é’Ÿæœ€å¤š 10 æ¬¡è°ƒç”¨

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·è¯´ï¼š"åˆ—å‡ºæ‰€æœ‰æ–‡æ¡£"
- ç”¨æˆ·è¯´ï¼š"æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨"
- ç”¨æˆ·è¯´ï¼š"æœ‰å“ªäº›æ–‡æ¡£ï¼Ÿ"
- ç”¨æˆ·è¯´ï¼š"æŸ¥çœ‹æ–‡æ¡£"

---

### 2. generate_mindmapï¼ˆç”Ÿæˆæ€ç»´è„‘å›¾ï¼‰

**å·¥å…·åç§°**: `generate_mindmap`

**å·¥å…·æè¿°**: æ ¹æ®å¯¹è¯ä¸­çš„æ–‡æ¡£å†…å®¹ç”Ÿæˆæ€ç»´å¯¼å›¾ã€‚å¯ä»¥æŒ‡å®šç‰¹å®šæ–‡æ¡£ï¼Œæˆ–ç”Ÿæˆæ‰€æœ‰æ–‡æ¡£çš„æ€ç»´å¯¼å›¾ã€‚ç”Ÿæˆçš„æ€ç»´å¯¼å›¾ä¼šä¿å­˜åˆ°å¯¹è¯ä¸­ï¼Œå¯ä»¥åœ¨æ€ç»´è„‘å›¾æ ‡ç­¾é¡µæŸ¥çœ‹ã€‚

**å‚æ•°è¯´æ˜**:

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|---------|--------|------|
| `conversation_id` | string | âœ… æ˜¯ | - | å¯¹è¯IDï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’ï¼‰ |
| `document_ids` | array[string] | âŒ å¦ | null | è¦ç”Ÿæˆæ€ç»´å¯¼å›¾çš„æ–‡æ¡£IDåˆ—è¡¨ã€‚å¦‚æœä¸æä¾›ï¼Œåˆ™ç”Ÿæˆæ‰€æœ‰æ–‡æ¡£çš„æ€ç»´å¯¼å›¾ |

**å‚æ•°ç¤ºä¾‹**:

```json
{
  "conversation_id": "abc123-def456-ghi789",
  "document_ids": ["doc1", "doc2"]
}
```

æˆ–è€…ä¸æŒ‡å®šæ–‡æ¡£ï¼ˆç”Ÿæˆæ‰€æœ‰æ–‡æ¡£ï¼‰:
```json
{
  "conversation_id": "abc123-def456-ghi789"
}
```

**è¿”å›å€¼**:

æˆåŠŸæ—¶:
```json
{
  "status": "success",
  "message": "æ€ç»´è„‘å›¾å·²ç”Ÿæˆï¼ˆåŸºäº 2 ä¸ªæ–‡æ¡£ï¼‰",
  "mindmap_content": "## æ–‡æ¡£å\n### 1. æ–‡ä»¶åŸºç¡€ä¿¡æ¯\n...",
  "document_count": 2,
  "document_names": ["æ–‡æ¡£1.pdf", "æ–‡æ¡£2.pdf"]
}
```

å¤±è´¥æ—¶:
```json
{
  "status": "error",
  "message": "é”™è¯¯ä¿¡æ¯",
  "error": "è¯¦ç»†é”™è¯¯"
}
```

**å¸¸è§é”™è¯¯**:
- `"å¯¹è¯ä¸­æ²¡æœ‰æ–‡æ¡£ï¼Œæ— æ³•ç”Ÿæˆæ€ç»´è„‘å›¾"`: å¯¹è¯ä¸­è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡æ¡£
- `"æŒ‡å®šçš„æ–‡æ¡£IDä¸å­˜åœ¨: [...]"`: æä¾›çš„ `document_ids` ä¸­åŒ…å«äº†ä¸å­˜åœ¨çš„æ–‡æ¡£ID
- `"æ²¡æœ‰å¯ç”¨çš„æ–‡æ¡£å†…å®¹"`: æ–‡æ¡£æ–‡ä»¶å­˜åœ¨ä½†æ— æ³•æå–æ–‡æœ¬å†…å®¹
- `"æ€ç»´è„‘å›¾ç”Ÿæˆå¤±è´¥ï¼Œæ— æ³•æå–æœ‰æ•ˆå†…å®¹"`: LLM ç”Ÿæˆçš„å†…å®¹æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©º

**é€Ÿç‡é™åˆ¶**: æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡è°ƒç”¨

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·è¯´ï¼š"è¯·ç”Ÿæˆæ€ç»´å¯¼å›¾"
- ç”¨æˆ·è¯´ï¼š"ç”»ä¸ªè„‘å›¾"
- ç”¨æˆ·è¯´ï¼š"ä¸ºæ–‡æ¡£1ç”Ÿæˆæ€ç»´å¯¼å›¾"

---

### 3. query_knowledge_graphï¼ˆæŸ¥è¯¢çŸ¥è¯†å›¾è°±ï¼‰

**å·¥å…·åç§°**: `query_knowledge_graph`

**å·¥å…·æè¿°**: åœ¨å¯¹è¯çš„çŸ¥è¯†å›¾è°±ä¸­æŸ¥è¯¢ä¿¡æ¯ã€‚æ”¯æŒå¤šç§æŸ¥è¯¢æ¨¡å¼ï¼šnaiveï¼ˆç®€å•æŸ¥è¯¢ï¼Œç›´æ¥æ£€ç´¢ç›¸å…³æ–‡æœ¬å—ï¼‰ã€localï¼ˆæœ¬åœ°å›¾è°±æŸ¥è¯¢ï¼ŒåŸºäºå®ä½“å’Œå…³ç³»ï¼‰ã€globalï¼ˆå…¨å±€æŸ¥è¯¢ï¼Œç»¼åˆåˆ†æï¼‰ã€mixï¼ˆæ··åˆæŸ¥è¯¢ï¼Œç»“åˆå¤šç§æ–¹å¼ï¼‰ã€‚

**å‚æ•°è¯´æ˜**:

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|---------|--------|------|
| `conversation_id` | string | âœ… æ˜¯ | - | å¯¹è¯IDï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’ï¼‰ |
| `query` | string | âœ… æ˜¯ | - | æŸ¥è¯¢æ–‡æœ¬ |
| `mode` | string | âŒ å¦ | "mix" | æŸ¥è¯¢æ¨¡å¼ï¼Œå¯é€‰å€¼ï¼š`naive`, `local`, `global`, `mix` |

**å‚æ•°ç¤ºä¾‹**:

```json
{
  "conversation_id": "abc123-def456-ghi789",
  "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
  "mode": "mix"
}
```

**æŸ¥è¯¢æ¨¡å¼è¯´æ˜**:

- **naive**: ç®€å•æŸ¥è¯¢ï¼Œç›´æ¥æ£€ç´¢ç›¸å…³æ–‡æœ¬å—ï¼Œé€Ÿåº¦æœ€å¿«
- **local**: æœ¬åœ°å›¾è°±æŸ¥è¯¢ï¼ŒåŸºäºå®ä½“å’Œå…³ç³»è¿›è¡ŒæŸ¥è¯¢ï¼Œé€‚åˆæŸ¥è¯¢ç‰¹å®šæ¦‚å¿µ
- **global**: å…¨å±€æŸ¥è¯¢ï¼Œç»¼åˆåˆ†ææ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼Œæœ€å…¨é¢ä½†è¾ƒæ…¢
- **mix**: æ··åˆæŸ¥è¯¢ï¼Œç»“åˆå¤šç§æ–¹å¼ï¼Œå¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§ï¼ˆæ¨èï¼‰

**è¿”å›å€¼**:

æˆåŠŸæ—¶:
```json
{
  "status": "success",
  "message": "æŸ¥è¯¢å®Œæˆï¼ˆæ¨¡å¼: mixï¼‰ï¼Œæ‰¾åˆ° 63 ä¸ªå®ä½“ï¼Œ58 ä¸ªå…³ç³»ï¼Œ11 ä¸ªæ–‡æœ¬å—",
  "result": "æŸ¥è¯¢æ¨¡å¼: mix\né«˜çº§å…³é”®è¯: è¯¾ç¨‹ä¿¡æ¯, è¯¾ç¨‹æŸ¥è¯¢\n...\næ‰¾åˆ° 63 ä¸ªç›¸å…³å®ä½“:\n1. è¯¾ç¨‹ç¼–ç  (ç±»å‹): æè¿°...\n...",
  "raw_data": {
    "entities": [...],
    "relationships": [...],
    "chunks": [...],
    "metadata": {...}
  },
  "mode": "mix",
  "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
}
```

**æ³¨æ„**: `result` å­—æ®µåŒ…å«æ ¼å¼åŒ–çš„æŸ¥è¯¢ç»“æœæ–‡æœ¬ï¼Œä¾› LLM ç†è§£ã€‚`raw_data` å­—æ®µåŒ…å«åŸå§‹çš„ç»“æ„åŒ–æ•°æ®ï¼ˆå®ä½“ã€å…³ç³»ã€æ–‡æœ¬å—ç­‰ï¼‰ã€‚

ä¿¡æ¯æç¤ºï¼ˆæ— æ–‡æ¡£æ—¶ï¼‰:
```json
{
  "status": "info",
  "message": "å¯¹è¯ä¸­æ²¡æœ‰æ–‡æ¡£ï¼Œå°†ä½¿ç”¨é€šç”¨çŸ¥è¯†å›ç­”",
  "result": null,
  "mode": "bypass"
}
```

å¤±è´¥æ—¶:
```json
{
  "status": "error",
  "message": "é”™è¯¯ä¿¡æ¯",
  "error": "è¯¦ç»†é”™è¯¯",
  "mode": "mix",
  "query": "åŸå§‹æŸ¥è¯¢"
}
```

**å¸¸è§é”™è¯¯**:
- `"æ— æ•ˆçš„æŸ¥è¯¢æ¨¡å¼: xxx"`: `mode` å‚æ•°å€¼ä¸åœ¨å…è®¸çš„åˆ—è¡¨ä¸­
- `"æŸ¥è¯¢çŸ¥è¯†å›¾è°±æ—¶å‡ºé”™: ..."`: LightRAG æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸

**é€Ÿç‡é™åˆ¶**: æ¯åˆ†é’Ÿæœ€å¤š 20 æ¬¡è°ƒç”¨

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·æé—®å…³äºæ–‡æ¡£å†…å®¹çš„é—®é¢˜
- ç”¨æˆ·éœ€è¦æŸ¥è¯¢ç‰¹å®šæ¦‚å¿µæˆ–çŸ¥è¯†ç‚¹

---

## æœ€ä½³å®è·µ

### 1. å·¥å…·é€‰æ‹©å»ºè®®

- **åˆ—å‡ºæ–‡æ¡£**: å½“ç”¨æˆ·è¦æ±‚æŸ¥çœ‹æ–‡æ¡£åˆ—è¡¨ã€æ˜¾ç¤ºæ–‡æ¡£ã€æœ‰å“ªäº›æ–‡æ¡£æ—¶ä½¿ç”¨ `list_documents`
- **ç”Ÿæˆæ€ç»´å¯¼å›¾**: å½“ç”¨æˆ·æ˜ç¡®è¦æ±‚ç”Ÿæˆæ€ç»´å¯¼å›¾ã€è„‘å›¾ã€æ€ç»´åœ°å›¾ç­‰æ—¶ä½¿ç”¨ `generate_mindmap`
- **æŸ¥è¯¢çŸ¥è¯†å›¾è°±**: å½“ç”¨æˆ·æé—®å…³äºæ–‡æ¡£å†…å®¹çš„é—®é¢˜æ—¶ä½¿ç”¨ `query_knowledge_graph`
- **æ™®é€šå¯¹è¯**: å½“ç”¨æˆ·åªæ˜¯èŠå¤©æˆ–æé—®ä¸€èˆ¬æ€§é—®é¢˜æ—¶ï¼Œä¸éœ€è¦è°ƒç”¨å·¥å…·

### 2. æŸ¥è¯¢æ¨¡å¼é€‰æ‹©

- **naive**: é€‚åˆå¿«é€Ÿæ£€ç´¢ï¼Œä¸éœ€è¦æ·±å…¥åˆ†æ
- **local**: é€‚åˆæŸ¥è¯¢ç‰¹å®šæ¦‚å¿µæˆ–å®ä½“
- **global**: é€‚åˆéœ€è¦å…¨é¢åˆ†æçš„å¤æ‚é—®é¢˜
- **mix**: æ¨èé»˜è®¤ä½¿ç”¨ï¼Œå¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§

### 3. é”™è¯¯å¤„ç†

- å·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ï¼ŒLLM åº”è¯¥å‘ç”¨æˆ·è§£é‡Šé”™è¯¯åŸå› 
- å¦‚æœå·¥å…·è¿”å› `info` çŠ¶æ€ï¼ˆå¦‚æ— æ–‡æ¡£ï¼‰ï¼ŒLLM åº”è¯¥å‘ŠçŸ¥ç”¨æˆ·å¹¶ç»§ç»­ä½¿ç”¨é€šç”¨çŸ¥è¯†å›ç­”

### 4. æµå¼å“åº”

- æ€ç»´è„‘å›¾ç”Ÿæˆæ˜¯æµå¼çš„ï¼Œå‰ç«¯ä¼šå®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
- å·¥å…·æ‰§è¡Œç»“æœä¼šç«‹å³è¿”å›ç»™ LLMï¼ŒLLM å¯ä»¥åŸºäºç»“æœç”Ÿæˆå›ç­”
- æœ€ç»ˆå›ç­”ä¹Ÿæ˜¯æµå¼çš„ï¼Œç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ° LLM çš„æ€è€ƒè¿‡ç¨‹

---

## å·¥å…·è°ƒç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç”Ÿæˆæ€ç»´è„‘å›¾ï¼ˆæ‰€æœ‰æ–‡æ¡£ï¼‰

**ç”¨æˆ·è¾“å…¥**: "è¯·ç”Ÿæˆæ€ç»´å¯¼å›¾"

**LLM è°ƒç”¨**:
```json
{
  "name": "generate_mindmap",
  "arguments": {
    "conversation_id": "abc123-def456-ghi789"
  }
}
```

**å·¥å…·æ‰§è¡Œ**: ç”Ÿæˆæ‰€æœ‰æ–‡æ¡£çš„æ€ç»´è„‘å›¾

**è¿”å›ç»“æœ**: æ€ç»´è„‘å›¾å†…å®¹ + æˆåŠŸæ¶ˆæ¯

---

### ç¤ºä¾‹ 2: ç”Ÿæˆæ€ç»´è„‘å›¾ï¼ˆæŒ‡å®šæ–‡æ¡£ï¼‰

**ç”¨æˆ·è¾“å…¥**: "ä¸ºæ–‡æ¡£1å’Œæ–‡æ¡£2ç”Ÿæˆæ€ç»´å¯¼å›¾"

**LLM è°ƒç”¨**:
```json
{
  "name": "generate_mindmap",
  "arguments": {
    "conversation_id": "abc123-def456-ghi789",
    "document_ids": ["doc1", "doc2"]
  }
}
```

**å·¥å…·æ‰§è¡Œ**: åªç”ŸæˆæŒ‡å®šæ–‡æ¡£çš„æ€ç»´è„‘å›¾

---

### ç¤ºä¾‹ 3: åˆ—å‡ºæ–‡æ¡£

**ç”¨æˆ·è¾“å…¥**: "åˆ—å‡ºæ‰€æœ‰æ–‡æ¡£"

**LLM è°ƒç”¨**:
```json
{
  "name": "list_documents",
  "arguments": {}
}
```

**å·¥å…·æ‰§è¡Œ**: åˆ—å‡ºå¯¹è¯ä¸­çš„æ‰€æœ‰æ–‡æ¡£

**è¿”å›ç»“æœ**: æ–‡æ¡£åˆ—è¡¨ + æˆåŠŸæ¶ˆæ¯

---

### ç¤ºä¾‹ 4: æŸ¥è¯¢çŸ¥è¯†å›¾è°±

**ç”¨æˆ·è¾“å…¥**: "æ–‡æ¡£ä¸­å…³äºç¥ç»ç½‘ç»œçš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ"

**LLM è°ƒç”¨**:
```json
{
  "name": "query_knowledge_graph",
  "arguments": {
    "conversation_id": "abc123-def456-ghi789",
    "query": "æ–‡æ¡£ä¸­å…³äºç¥ç»ç½‘ç»œçš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
    "mode": "mix"
  }
}
```

**å·¥å…·æ‰§è¡Œ**: åœ¨çŸ¥è¯†å›¾è°±ä¸­æŸ¥è¯¢ç›¸å…³ä¿¡æ¯

---

## å·¥å…·è°ƒç”¨æµç¨‹è¯¦è§£

### 1. ç”¨æˆ·è¾“å…¥å¤„ç†

```python
# å‰ç«¯å‘é€è¯·æ±‚
POST /api/conversations/{conversation_id}/query/stream
{
  "query": "è¯·ç”Ÿæˆæ€ç»´å¯¼å›¾",
  "mode": "agent"
}
```

### 2. Agent æœåŠ¡å¤„ç†

```python
# AgentService.process_user_query()
# 1. è·å–å·¥å…·åˆ—è¡¨ï¼ˆè½¬æ¢ä¸º Function Calling æ ¼å¼ï¼‰
functions = tool_registry.to_function_calling_format()

# 2. è°ƒç”¨ LLMï¼ˆä¼ é€’å·¥å…·å®šä¹‰ï¼‰
result = await llm.chat(
    messages=[...],
    tools=functions,  # å·¥å…·å®šä¹‰
    tool_choice="auto"  # è‡ªåŠ¨é€‰æ‹©å·¥å…·
)
```

### 3. LLM è¿”å›å·¥å…·è°ƒç”¨

```json
{
  "tool_calls": [
    {
      "id": "call_123",
      "type": "function",
      "function": {
        "name": "generate_mindmap",
        "arguments": "{\"conversation_id\": \"abc123\"}"
      }
    }
  ]
}
```

### 4. å·¥å…·æ‰§è¡Œ

```python
# ToolExecutor.execute()
result = await tool.handler(**parameters)
```

### 5. ç»“æœè¿”å›

```python
# è¿”å›ç»™ LLM å’Œå‰ç«¯
{
  "type": "tool_result",
  "tool_name": "generate_mindmap",
  "result": {...}
}
```

---

## å‚æ•°è‡ªåŠ¨æ³¨å…¥

**é‡è¦**: `conversation_id` å‚æ•°ä¼šè‡ªåŠ¨æ³¨å…¥ï¼ŒLLM è°ƒç”¨å·¥å…·æ—¶**ä¸éœ€è¦**æä¾›æ­¤å‚æ•°ã€‚

å·¥å…·æ‰§è¡Œå™¨ä¼šè‡ªåŠ¨ä»ä¸Šä¸‹æ–‡ä¸­è·å– `conversation_id` å¹¶æ³¨å…¥åˆ°å·¥å…·å‚æ•°ä¸­ã€‚

### è‡ªåŠ¨æ³¨å…¥æœºåˆ¶

1. **å·¥å…·å®šä¹‰**: åœ¨ `ToolDefinition` ä¸­ï¼Œ`conversation_id` å¿…é¡»æ ‡è®°ä¸º `required=True`
2. **Function Calling æ ¼å¼è½¬æ¢**: `to_function_calling_format()` ä¼šè‡ªåŠ¨æ’é™¤ `conversation_id`ï¼Œä¸ä¼ é€’ç»™ LLM
3. **å·¥å…·æ‰§è¡Œ**: `ToolExecutor.execute()` ä¼šè‡ªåŠ¨ä»ä¸Šä¸‹æ–‡è·å– `conversation_id` å¹¶æ³¨å…¥

### ç¤ºä¾‹

**LLM è°ƒç”¨**ï¼ˆä¸åŒ…å« conversation_idï¼‰:
```json
{
  "name": "query_knowledge_graph",
  "arguments": {
    "query": "è¯¾ç¨‹ä¿¡æ¯",
    "mode": "mix"
  }
}
```

**å®é™…æ‰§è¡Œ**ï¼ˆè‡ªåŠ¨æ³¨å…¥ conversation_idï¼‰:
```python
await query_knowledge_graph_handler(
    conversation_id="abc123-def456-ghi789",  # è‡ªåŠ¨æ³¨å…¥
    query="è¯¾ç¨‹ä¿¡æ¯",
    mode="mix"
)
```

---

## é”™è¯¯å¤„ç†

### å‚æ•°éªŒè¯é”™è¯¯

å¦‚æœå‚æ•°ä¸ç¬¦åˆè¦æ±‚ï¼Œå·¥å…·æ‰§è¡Œå™¨ä¼šè¿”å›:
```json
{
  "status": "error",
  "message": "å‚æ•°éªŒè¯å¤±è´¥: ç¼ºå°‘å¿…éœ€å‚æ•°: query",
  "tool_name": "query_knowledge_graph"
}
```

**å¸¸è§éªŒè¯é”™è¯¯**:
- ç¼ºå°‘å¿…éœ€å‚æ•°ï¼ˆå¦‚ `query`ï¼‰
- å‚æ•°ç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚ `document_ids` åº”è¯¥æ˜¯æ•°ç»„ï¼‰
- æšä¸¾å€¼ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼ˆå¦‚ `mode` å¿…é¡»æ˜¯ `naive/local/global/mix` ä¹‹ä¸€ï¼‰

### é€Ÿç‡é™åˆ¶é”™è¯¯

å¦‚æœè¶…è¿‡é€Ÿç‡é™åˆ¶ï¼Œä¼šè¿”å›:
```json
{
  "status": "error",
  "message": "å·¥å…·è°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•",
  "tool_name": "generate_mindmap"
}
```

**é€Ÿç‡é™åˆ¶**:
- `generate_mindmap`: æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡
- `query_knowledge_graph`: æ¯åˆ†é’Ÿæœ€å¤š 20 æ¬¡

### æ‰§è¡Œé”™è¯¯

å¦‚æœå·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œä¼šè¿”å›:
```json
{
  "status": "error",
  "message": "å·¥å…·æ‰§è¡Œå¤±è´¥: è¯¦ç»†é”™è¯¯ä¿¡æ¯",
  "tool_name": "generate_mindmap",
  "error": "é”™è¯¯å †æ ˆ"
}
```

### JSON è§£æé”™è¯¯

å¦‚æœ LLM è¿”å›çš„å·¥å…·å‚æ•° JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œä¼šè¿”å›:
```json
{
  "type": "tool_error",
  "tool_name": "query_knowledge_graph",
  "message": "å·¥å…·å‚æ•°è§£æå¤±è´¥: {...}, é”™è¯¯: Expecting ',' delimiter: line 1 column 10"
}
```

### LLM API é”™è¯¯

å¦‚æœè°ƒç”¨ LLM API æ—¶å‡ºé”™ï¼Œä¼šè¿”å›:
```json
{
  "type": "error",
  "content": "LLM API é”™è¯¯: 400, {\"code\":20015,\"message\":\"Field required\",\"data\":null}"
}
```

**å¸¸è§ LLM API é”™è¯¯**:
- `400 Field required`: è¯·æ±‚ä¸­ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆé€šå¸¸æ˜¯æ¶ˆæ¯æ ¼å¼é—®é¢˜ï¼‰
- `401 Unauthorized`: API Key æ— æ•ˆæˆ–è¿‡æœŸ
- `429 Too Many Requests`: è¯·æ±‚é¢‘ç‡è¿‡é«˜
- `500 Internal Server Error`: LLM æœåŠ¡å†…éƒ¨é”™è¯¯

---

## è°ƒè¯•å’Œæ•…éšœæ’é™¤

### æŸ¥çœ‹å·¥å…·æ‰§è¡Œæ—¥å¿—

åç«¯æ§åˆ¶å°ä¼šè¾“å‡ºè¯¦ç»†çš„å·¥å…·æ‰§è¡Œæ—¥å¿—ï¼š

```
âœ… å·¥å…·å·²æ³¨å†Œ: generate_mindmap (mindmap)
âœ… å·¥å…·å·²æ³¨å†Œ: query_knowledge_graph (query)
ğŸ“¦ Agent æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œå·²æ³¨å†Œ 2 ä¸ªå·¥å…·
ğŸ”§ æ‰§è¡Œå·¥å…·: query_knowledge_graph, å‚æ•°: {'query': 'è¯¾ç¨‹ä¿¡æ¯', 'mode': 'mix', 'conversation_id': '...'}
âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ: query_knowledge_graph
```

### å¸¸è§é—®é¢˜

#### 1. å·¥å…·æ²¡æœ‰è¢«è°ƒç”¨

**å¯èƒ½åŸå› **:
- Agent æ¨¡å¼æœªå¼€å¯
- ç”¨æˆ·æ„å›¾ä¸å¤Ÿæ˜ç¡®
- LLM è®¤ä¸ºä¸éœ€è¦è°ƒç”¨å·¥å…·

**è§£å†³æ–¹æ³•**:
- ç¡®ä¿å‰ç«¯ Agent æ¨¡å¼å¼€å…³å·²å¼€å¯
- ä½¿ç”¨æ›´æ˜ç¡®çš„æŒ‡ä»¤ï¼ˆå¦‚"è¯·ç”Ÿæˆæ€ç»´å¯¼å›¾"è€Œä¸æ˜¯"å¸®æˆ‘çœ‹çœ‹"ï¼‰
- æ£€æŸ¥ç³»ç»Ÿæç¤ºè¯æ˜¯å¦æ­£ç¡®å¼•å¯¼ LLM ä½¿ç”¨å·¥å…·

#### 2. å·¥å…·æ‰§è¡Œå¤±è´¥

**å¯èƒ½åŸå› **:
- å‚æ•°æ ¼å¼ä¸æ­£ç¡®
- å¯¹è¯ä¸­æ²¡æœ‰æ–‡æ¡£
- é€Ÿç‡é™åˆ¶

**è§£å†³æ–¹æ³•**:
- æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®ä¿å¯¹è¯ä¸­å·²ä¸Šä¼ æ–‡æ¡£
- ç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®åå†è¯•

#### 3. LLM è¿”å›æ ¼å¼é”™è¯¯

**å¯èƒ½åŸå› **:
- LLM ç”Ÿæˆçš„å·¥å…·å‚æ•° JSON æ ¼å¼ä¸æ­£ç¡®
- æ¶ˆæ¯å†å²ä¸­åŒ…å«æ ¼å¼ä¸æ­£ç¡®çš„æ¶ˆæ¯

**è§£å†³æ–¹æ³•**:
- ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†æ ¼å¼ä¸æ­£ç¡®çš„å†å²æ¶ˆæ¯
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„è­¦å‘Šä¿¡æ¯
- å¦‚æœé—®é¢˜æŒç»­ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å¯¹è¯å†å²

#### 4. "Field required" é”™è¯¯

**å¯èƒ½åŸå› **:
- æ¶ˆæ¯æ ¼å¼ä¸ç¬¦åˆ LLM API è¦æ±‚
- `tool_calls` ä¸­çš„å­—æ®µç¼ºå¤±æˆ–ä¸ºç©º

**è§£å†³æ–¹æ³•**:
- ç³»ç»Ÿå·²è‡ªåŠ¨æ·»åŠ éªŒè¯å’Œä¿®å¤é€»è¾‘
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ¶ˆæ¯æ ¼å¼æ£€æŸ¥ä¿¡æ¯
- ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰å¿…éœ€çš„å­—æ®µ

## æ‰©å±•æ–°å·¥å…·

è¦æ·»åŠ æ–°å·¥å…·ï¼Œåªéœ€ï¼š

1. åœ¨ `backend/app/services/agent/tools/` ç›®å½•ä¸‹åˆ›å»ºæ–°å·¥å…·æ–‡ä»¶
2. å®šä¹‰å·¥å…·å¤„ç†å‡½æ•°ï¼ˆå¼‚æ­¥å‡½æ•°ï¼‰
3. åˆ›å»º `ToolDefinition` å¯¹è±¡
4. åœ¨ `AgentService._register_default_tools()` ä¸­æ³¨å†Œå·¥å…·

### å®Œæ•´ç¤ºä¾‹

```python
# tools/my_tool.py
"""
æˆ‘çš„å·¥å…·æ¨¡å—

å·¥å…·æè¿°ï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å·¥å…·ï¼Œç”¨äºæ¼”ç¤ºå¦‚ä½•åˆ›å»ºæ–°å·¥å…·ã€‚
"""
from typing import Dict, Any, Optional
from app.services.agent.tool_registry import ToolDefinition, ToolParameter

async def my_tool_handler(
    conversation_id: str,
    param1: str,
    param2: Optional[int] = None
) -> Dict[str, Any]:
    """æˆ‘çš„å·¥å…·å¤„ç†å‡½æ•°
    
    Args:
        conversation_id: å¯¹è¯IDï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼‰
        param1: å¿…éœ€å‚æ•°1
        param2: å¯é€‰å‚æ•°2
        
    Returns:
        å·¥å…·æ‰§è¡Œç»“æœ
    """
    try:
        # å·¥å…·é€»è¾‘
        result = f"å¤„ç†äº† {param1}ï¼Œå‚æ•°2: {param2}"
        
        return {
            "status": "success",
            "message": "æ‰§è¡ŒæˆåŠŸ",
            "result": result
        }
    except Exception as e:
        return {
            "status": "error",
            "message": f"æ‰§è¡Œå¤±è´¥: {str(e)}",
            "error": str(e)
        }

# å®šä¹‰å·¥å…·
MY_TOOL = ToolDefinition(
    name="my_tool",
    description="è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å·¥å…·ï¼Œç”¨äºæ¼”ç¤ºå¦‚ä½•åˆ›å»ºæ–°å·¥å…·",
    parameters={
        "conversation_id": ToolParameter(
            type="string",
            description="å¯¹è¯ID",
            required=True
        ),
        "param1": ToolParameter(
            type="string",
            description="å¿…éœ€å‚æ•°1",
            required=True
        ),
        "param2": ToolParameter(
            type="number",
            description="å¯é€‰å‚æ•°2",
            required=False,
            default=None
        )
    },
    handler=my_tool_handler,
    category="custom",
    rate_limit=10  # æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡
)
```

```python
# agent_service.py
def _register_default_tools(self):
    """æ³¨å†Œé»˜è®¤å·¥å…·"""
    self.tool_registry.register(MINDMAP_TOOL)
    self.tool_registry.register(QUERY_TOOL)
    
    # æ³¨å†Œæ–°å·¥å…·
    from app.services.agent.tools.my_tool import MY_TOOL
    self.tool_registry.register(MY_TOOL)
    
    print(f"ğŸ“¦ Agent æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œå·²æ³¨å†Œ {len(self.tool_registry.tools)} ä¸ªå·¥å…·")
```

### å·¥å…·å¼€å‘æ³¨æ„äº‹é¡¹

1. **conversation_id è‡ªåŠ¨æ³¨å…¥**: å·¥å…·å®šä¹‰ä¸­å¿…é¡»åŒ…å« `conversation_id` å‚æ•°ï¼Œä½† LLM è°ƒç”¨æ—¶ä¸éœ€è¦æä¾›ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ³¨å…¥ã€‚

2. **è¿”å›å€¼æ ¼å¼**: å·¥å…·å¤„ç†å‡½æ•°å¿…é¡»è¿”å›åŒ…å« `status` å­—æ®µçš„å­—å…¸ï¼š
   - `status`: `"success"` æˆ– `"error"`
   - `message`: æ‰§è¡Œç»“æœæè¿°
   - `result`: å®é™…ç»“æœï¼ˆå¯é€‰ï¼‰
   - `error`: é”™è¯¯è¯¦æƒ…ï¼ˆä»…é”™è¯¯æ—¶ï¼‰

3. **å¼‚æ­¥å‡½æ•°**: å·¥å…·å¤„ç†å‡½æ•°åº”è¯¥æ˜¯å¼‚æ­¥å‡½æ•°ï¼ˆä½¿ç”¨ `async def`ï¼‰ï¼Œé™¤éç¡®å®šä¸éœ€è¦å¼‚æ­¥æ“ä½œã€‚

4. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `try-except` æ•è·å¼‚å¸¸ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–çš„é”™è¯¯ä¿¡æ¯ã€‚

5. **é€Ÿç‡é™åˆ¶**: æ ¹æ®å·¥å…·çš„å®é™…ä½¿ç”¨åœºæ™¯è®¾ç½®åˆç†çš„ `rate_limit`ã€‚

6. **å‚æ•°éªŒè¯**: ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯å‚æ•°ç±»å‹å’Œå¿…éœ€æ€§ï¼Œä½†å·¥å…·å†…éƒ¨ä¹Ÿåº”è¯¥è¿›è¡Œä¸šåŠ¡é€»è¾‘éªŒè¯ã€‚

---

## æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

- âœ… **è‡ªåŠ¨å·¥å…·é€‰æ‹©**: LLM æ ¹æ®ç”¨æˆ·æ„å›¾è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å·¥å…·
- âœ… **å‚æ•°è‡ªåŠ¨æ³¨å…¥**: `conversation_id` è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’
- âœ… **æµå¼å“åº”**: æ”¯æŒå®æ—¶è¿”å›å·¥å…·æ‰§è¡Œç»“æœå’Œ LLM å›ç­”
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯æœºåˆ¶
- âœ… **é€Ÿç‡é™åˆ¶**: é˜²æ­¢å·¥å…·è¢«è¿‡åº¦è°ƒç”¨
- âœ… **æ˜“äºæ‰©å±•**: ç®€å•çš„å·¥å…·æ³¨å†Œæœºåˆ¶

### å¿«é€Ÿå‚è€ƒ

| å·¥å…· | ç”¨é€” | å¿…éœ€å‚æ•° | é€Ÿç‡é™åˆ¶ |
|------|------|---------|---------|
| `list_documents` | åˆ—å‡ºæ–‡æ¡£ | æ—  | 10æ¬¡/åˆ†é’Ÿ |
| `generate_mindmap` | ç”Ÿæˆæ€ç»´å¯¼å›¾ | æ— ï¼ˆå¯é€‰ï¼š`document_ids`ï¼‰ | 5æ¬¡/åˆ†é’Ÿ |
| `query_knowledge_graph` | æŸ¥è¯¢çŸ¥è¯†å›¾è°± | `query` | 20æ¬¡/åˆ†é’Ÿ |

### ç›¸å…³æ–‡ä»¶

- **å·¥å…·å®šä¹‰**: `backend/app/services/agent/tools/`
- **å·¥å…·æ³¨å†Œ**: `backend/app/services/agent/tool_registry.py`
- **å·¥å…·æ‰§è¡Œ**: `backend/app/services/agent/tool_executor.py`
- **Agent æœåŠ¡**: `backend/app/services/agent/agent_service.py`
- **API è·¯ç”±**: `backend/app/api/graph.py` (Agent æ¨¡å¼å¤„ç†)

### æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹åç«¯æ§åˆ¶å°æ—¥å¿—
2. æ£€æŸ¥å·¥å…·æ‰§è¡Œç»“æœ
3. éªŒè¯æ¶ˆæ¯æ ¼å¼
4. å‚è€ƒæœ¬æ–‡æ¡£çš„é”™è¯¯å¤„ç†ç« èŠ‚

