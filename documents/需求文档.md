# 基于 LightRAG 的 Web 应用程序需求文档

## 1. 项目概述

本项目旨在构建一个基于 LightRAG 的 Web 应用程序，主要面向教育场景，支持 PPT 文档的知识抽取、知识图谱可视化展示，以及基于多 Agent 架构的智能习题生成功能。

### 1.1 项目目标

- 实现 PPT/PDF 文档的知识抽取和知识图谱构建
- 提供直观的 PPT 可视化展示和知识图谱交互界面
- 构建多 Agent 系统，实现基于历史习题的智能习题生成

### 1.2 技术栈

- **后端**: Python, FastAPI, LightRAG
- **前端**: React/Vue.js, D3.js/Cytoscape.js (知识图谱可视化)
- **存储**: 根据 LightRAG 配置选择（默认 JSON 文件存储，生产环境可使用 PostgreSQL/Neo4j）
- **LLM**: 支持 OpenAI, Ollama, Azure OpenAI 等
- **文档处理**: textract, python-pptx, PyPDF2

## 2. 功能需求

### 2.1 文档上传与知识抽取模块

#### 2.1.1 功能描述

支持上传 PPTX、PPT、PDF 格式的文档，自动进行知识抽取，构建知识图谱。

#### 2.1.2 详细需求

**支持的文件格式**:
- `.pptx` - PowerPoint 2007 及以上版本
- `.ppt` - PowerPoint 97-2003 版本
- `.pdf` - PDF 文档

**文档处理流程**:
1. **文档上传**
   - 用户通过 Web 界面上传文档
   - 文件大小限制：单文件最大 50MB
   - 支持批量上传（最多 10 个文件）
   - 上传后文件存储到服务器 `uploads/` 目录

2. **文档解析**
   - PPTX/PPT: 使用 `python-pptx` 提取文本内容、幻灯片结构、图片描述
   - PDF: 使用 `textract` 或 `PyPDF2` 提取文本内容
   - 保留文档元信息：文件名、页数、上传时间等

3. **文本分块**
   - 按照幻灯片/页面进行分块（每个幻灯片/页面为一个基本块）
   - 对于长文本，按照 LightRAG 默认参数进行子分块：
     - `chunk_token_size`: 1200 tokens
     - `chunk_overlap_token_size`: 100 tokens
   - 保留分块与原始幻灯片/页面的映射关系

4. **知识抽取**
   - 使用 LightRAG 的实体提取功能
   - 提取实体类型：概念、人物、地点、组织、时间、事件等
   - 提取实体之间的关系：包含、属于、相关、导致等
   - 为每个实体和关系生成向量表示

5. **知识图谱构建**
   - 将提取的实体和关系构建成知识图谱
   - 存储到 LightRAG 的图存储中
   - 保留实体和关系与源文档、幻灯片/页面的关联

**处理状态跟踪**:
- 实时显示文档处理状态（待处理/处理中/已完成/失败）
- 显示处理进度（已处理页数/总页数）
- 支持查看处理日志和错误信息

#### 2.1.3 接口设计

```python
# 文档上传接口
POST /api/documents/upload
请求: multipart/form-data
- files: List[UploadFile]

响应:
{
    "track_id": "uuid",
    "status": "pending",
    "files": [
        {
            "file_id": "uuid",
            "filename": "example.pptx",
            "file_size": 1024000,
            "upload_time": "2024-01-01T00:00:00Z"
        }
    ]
}

# 查询处理状态
GET /api/documents/status/{track_id}
响应:
{
    "track_id": "uuid",
    "status": "processing",
    "progress": {
        "total_files": 5,
        "processed_files": 2,
        "current_file": "example.pptx",
        "current_page": 10,
        "total_pages": 20
    },
    "errors": []
}
```

### 2.2 PPT 可视化展示模块

#### 2.2.1 功能描述

在 Web 界面左侧提供 PPT 文档的可视化展示，支持幻灯片浏览、搜索、标注等功能。

#### 2.2.2 详细需求

**幻灯片展示**:
1. **缩略图导航**
   - 显示所有幻灯片的缩略图
   - 支持点击缩略图跳转到对应幻灯片
   - 缩略图显示幻灯片编号和标题（如果有）

2. **幻灯片查看器**
   - 全屏显示当前幻灯片内容
   - 支持幻灯片缩放（50%-200%）
   - 支持上一张/下一张导航
   - 显示当前幻灯片在文档中的位置（第 X 张/共 Y 张）

3. **内容渲染**
   - 渲染文本内容（保留原始格式：字体、颜色、大小）
   - 渲染图片（如果有）
   - 渲染表格（如果有）
   - 标注已提取的知识实体（高亮显示）

**交互功能**:
1. **实体标注**
   - 在幻灯片上高亮显示已提取的知识实体
   - 鼠标悬停显示实体详情（名称、类型、描述）
   - 点击实体跳转到知识图谱中对应的节点

2. **搜索功能**
   - 在幻灯片中搜索关键词
   - 高亮显示搜索结果
   - 支持正则表达式搜索

3. **注释功能**
   - 支持为幻灯片添加注释
   - 注释与幻灯片关联存储
   - 支持编辑和删除注释

#### 2.2.3 接口设计

```python
# 获取文档幻灯片列表
GET /api/documents/{doc_id}/slides
响应:
{
    "doc_id": "uuid",
    "filename": "example.pptx",
    "slides": [
        {
            "slide_id": "uuid",
            "slide_number": 1,
            "title": "第一章",
            "thumbnail_url": "/api/documents/{doc_id}/slides/{slide_id}/thumbnail",
            "entities": [
                {
                    "entity_id": "uuid",
                    "name": "人工智能",
                    "type": "Concept",
                    "position": {"x": 100, "y": 200, "width": 150, "height": 30}
                }
            ]
        }
    ]
}

# 获取幻灯片内容
GET /api/documents/{doc_id}/slides/{slide_id}
响应:
{
    "slide_id": "uuid",
    "slide_number": 1,
    "content": {
        "text": "幻灯片文本内容",
        "images": [
            {
                "image_id": "uuid",
                "url": "/api/images/{image_id}",
                "alt_text": "图片描述"
            }
        ],
        "tables": [...]
    },
    "entities": [...]
}
```

### 2.3 知识图谱展示模块

#### 2.3.1 功能描述

在 Web 界面右侧提供知识图谱的可视化展示和交互功能。

#### 2.3.2 详细需求

**图谱可视化**:
1. **图谱渲染**
   - 使用 D3.js 或 Cytoscape.js 渲染知识图谱
   - 节点表示实体，边表示关系
   - 支持节点大小根据连接度调整
   - 支持节点颜色根据实体类型区分
   - 支持边的粗细根据关系强度调整

2. **布局算法**
   - 默认使用力导向布局（Force-Directed Layout）
   - 支持其他布局算法：层次布局、网格布局、圆形布局
   - 支持手动拖拽节点调整位置
   - 支持保存和加载布局配置

3. **交互功能**
   - **节点交互**
     - 点击节点显示详情：名称、类型、描述、相关文档、相关幻灯片
     - 双击节点展开/折叠邻居节点
     - 鼠标悬停高亮节点及其连接
     - 支持节点搜索和定位
   - **边交互**
     - 点击边显示关系详情：类型、描述、强度
     - 鼠标悬停高亮边及其两端节点
   - **图谱操作**
     - 缩放：鼠标滚轮或工具栏按钮
     - 平移：拖拽画布
     - 重置视图：一键回到初始视图
     - 导出图谱：支持导出为 PNG/SVG/JSON

4. **过滤与筛选**
   - 按实体类型过滤（概念、人物、地点等）
   - 按关系类型过滤
   - 按文档来源过滤
   - 按连接度过滤（只显示连接度大于 N 的节点）
   - 搜索实体和关系

#### 2.3.3 接口设计

```python
# 获取知识图谱数据
GET /api/graph
查询参数:
- doc_ids: List[str] (可选，过滤特定文档)
- entity_types: List[str] (可选，过滤实体类型)
- min_degree: int (可选，最小连接度)
- limit: int (可选，限制节点数量)

响应:
{
    "nodes": [
        {
            "id": "entity_uuid",
            "name": "人工智能",
            "type": "Concept",
            "description": "实体描述",
            "degree": 5,
            "docs": ["doc_uuid1", "doc_uuid2"],
            "slides": [{"doc_id": "uuid", "slide_id": "uuid", "slide_number": 1}]
        }
    ],
    "edges": [
        {
            "id": "relation_uuid",
            "source": "entity_uuid1",
            "target": "entity_uuid2",
            "type": "包含",
            "description": "关系描述",
            "strength": 0.85
        }
    ]
}

# 获取实体详情
GET /api/graph/entities/{entity_id}
响应:
{
    "entity_id": "uuid",
    "name": "人工智能",
    "type": "Concept",
    "description": "详细描述",
    "related_entities": [...],
    "related_relations": [...],
    "source_docs": [...],
    "source_slides": [...]
}
```

### 2.4 对话与查询模块

#### 2.4.1 功能描述

提供基于 LightRAG 的智能问答功能，用户可以就文档内容进行提问。

#### 2.4.2 详细需求

**查询功能**:
1. **查询模式选择**
   - 支持选择查询模式：local、global、hybrid、naive、mix（默认 mix）
   - 提供模式说明，帮助用户选择合适的模式

2. **对话界面**
   - 显示对话历史
   - 支持多轮对话（保持上下文）
   - 实时显示查询进度（检索中、生成中）
   - 支持流式输出（逐字显示回答）

3. **结果展示**
   - 显示回答内容
   - 显示引用来源（文档、幻灯片、文本块）
   - 高亮显示回答中提到的实体
   - 支持点击实体跳转到知识图谱

4. **高级功能**
   - 支持自定义用户提示（user_prompt）
   - 支持设置响应格式（段落、列表、表格等）
   - 支持导出对话记录

#### 2.4.3 接口设计

```python
# 查询接口
POST /api/query
请求:
{
    "query": "什么是人工智能？",
    "mode": "mix",
    "doc_ids": ["doc_uuid1", "doc_uuid2"],  # 可选，限制查询范围
    "stream": false,
    "user_prompt": "",  # 可选
    "response_type": "Multiple Paragraphs"
}

响应:
{
    "answer": "回答内容",
    "mode": "mix",
    "entities": [
        {
            "entity_id": "uuid",
            "name": "人工智能",
            "relevance_score": 0.95
        }
    ],
    "references": [
        {
            "doc_id": "uuid",
            "doc_name": "example.pptx",
            "slide_id": "uuid",
            "slide_number": 1,
            "chunk_id": "uuid",
            "chunk_content": "相关文本块内容",
            "relevance_score": 0.88
        }
    ],
    "context_used": {
        "entities_count": 5,
        "relations_count": 3,
        "chunks_count": 4
    }
}

# 流式查询接口
POST /api/query/stream
请求: 同上
响应: Server-Sent Events (SSE)
```

### 2.5 多 Agent 习题生成模块

#### 2.5.1 功能描述

基于多个 PPT 文档和历史期末题，使用多 Agent 架构抽取知识点，生成难度相似、题型相近的期末习题和答案。

#### 2.5.2 详细需求

**Agent 架构设计**:

1. **文档分析 Agent**
   - **职责**: 分析上传的 PPT 文档，提取知识点结构
   - **输入**: PPT 文档列表
   - **输出**: 知识点列表、知识点的层级关系、知识点难度评估
   - **实现方式**: 
     - 使用 LightRAG 提取知识点实体
     - 使用 LLM 分析知识点之间的层级关系
     - 使用 LLM 评估知识点难度（1-5 级）

2. **习题分析 Agent**
   - **职责**: 分析历史期末题，提取题型、难度、知识点覆盖等信息
   - **输入**: 历史期末题文档（PDF/TXT）
   - **输出**: 
     - 题型分类（选择题、填空题、简答题、计算题等）
     - 每道题的难度等级
     - 每道题涉及的知识点
     - 题型特征（题目长度、选项数量、答案格式等）
   - **实现方式**:
     - 使用 LLM 识别题型
     - 使用 LLM 提取题目中的知识点
     - 使用 LLM 评估题目难度

3. **知识点匹配 Agent**
   - **职责**: 匹配 PPT 中的知识点与历史习题中的知识点
   - **输入**: PPT 知识点列表、历史习题知识点列表
   - **输出**: 知识点映射关系、知识点覆盖度分析
   - **实现方式**:
     - 使用向量相似度匹配知识点
     - 使用 LLM 进行语义匹配
     - 构建知识点映射表

4. **习题生成 Agent**
   - **职责**: 基于知识点和题型特征生成新习题
   - **输入**: 
     - 目标知识点列表
     - 题型要求
     - 难度要求
     - 参考习题（可选）
   - **输出**: 生成的习题和答案
   - **实现方式**:
     - 使用 LLM 生成习题内容
     - 确保生成的习题符合题型特征
     - 确保难度匹配要求
     - 生成标准答案和评分标准

5. **质量评估 Agent**
   - **职责**: 评估生成的习题质量
   - **输入**: 生成的习题
   - **输出**: 质量评分、改进建议
   - **评估维度**:
     - 知识点覆盖度
     - 难度匹配度
     - 题型相似度
     - 题目清晰度
     - 答案准确性
   - **实现方式**: 使用 LLM 进行多维度评估

**工作流程**:

```
1. 用户上传 PPT 文档和历史期末题
   ↓
2. 文档分析 Agent 提取 PPT 知识点
   习题分析 Agent 分析历史期末题
   ↓
3. 知识点匹配 Agent 匹配知识点
   ↓
4. 用户设置生成参数
   - 题型选择（选择题、填空题等）
   - 难度要求（1-5 级）
   - 知识点范围
   - 生成数量
   ↓
5. 习题生成 Agent 生成习题
   ↓
6. 质量评估 Agent 评估习题质量
   ↓
7. 返回生成的习题列表（包含质量评分）
   ↓
8. 用户可选择接受、修改或重新生成
```

**生成参数设置**:
- **题型选择**: 多选（支持选择题、填空题、简答题、计算题等）
- **难度等级**: 1-5 级（或自动匹配历史习题的平均难度）
- **知识点范围**: 可选择特定章节或知识点
- **生成数量**: 每个题型生成多少道题
- **相似度控制**: 控制与历史习题的相似程度（避免过于相似）

#### 2.5.3 接口设计

```python
# 上传历史期末题
POST /api/exercises/upload-history
请求: multipart/form-data
- files: List[UploadFile] (PDF/TXT 格式)

响应:
{
    "track_id": "uuid",
    "status": "pending",
    "files": [...]
}

# 开始习题生成任务
POST /api/exercises/generate
请求:
{
    "doc_ids": ["doc_uuid1", "doc_uuid2"],  # PPT 文档 ID
    "history_track_id": "uuid",  # 历史习题处理 track_id
    "config": {
        "question_types": ["选择题", "填空题", "简答题"],
        "difficulty_level": 3,  # 或 "auto"
        "knowledge_points": ["知识点1", "知识点2"],  # 可选，为空则覆盖所有
        "questions_per_type": {
            "选择题": 10,
            "填空题": 5,
            "简答题": 3
        },
        "similarity_threshold": 0.7  # 与历史习题相似度阈值
    }
}

响应:
{
    "task_id": "uuid",
    "status": "processing",
    "estimated_time": 300  # 预计处理时间（秒）
}

# 查询生成进度
GET /api/exercises/generate/{task_id}/status
响应:
{
    "task_id": "uuid",
    "status": "processing",  # pending/processing/completed/failed
    "progress": {
        "total_questions": 18,
        "generated_questions": 12,
        "current_type": "简答题",
        "current_step": "质量评估"
    }
}

# 获取生成的习题
GET /api/exercises/generate/{task_id}/results
响应:
{
    "task_id": "uuid",
    "status": "completed",
    "questions": [
        {
            "question_id": "uuid",
            "type": "选择题",
            "content": "题目内容",
            "options": ["选项A", "选项B", "选项C", "选项D"],
            "answer": "A",
            "explanation": "答案解析",
            "knowledge_points": ["知识点1", "知识点2"],
            "difficulty": 3,
            "quality_score": 0.92,
            "similarity_to_history": 0.75,
            "source_docs": ["doc_uuid1"],
            "source_slides": [{"doc_id": "uuid", "slide_id": "uuid", "slide_number": 5}]
        }
    ],
    "statistics": {
        "total_questions": 18,
        "average_quality_score": 0.88,
        "difficulty_distribution": {
            "1": 2,
            "2": 5,
            "3": 8,
            "4": 2,
            "5": 1
        }
    }
}

# 导出习题
POST /api/exercises/export
请求:
{
    "task_id": "uuid",
    "format": "pdf",  # pdf/docx/txt
    "include_answer": true,
    "include_explanation": true
}
响应: 文件下载
```

## 3. 系统架构设计

### 3.1 整体架构

采用前后端分离的架构，后端提供 REST API，前端使用 React/Vue.js 构建单页应用。

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │ PPT 展示  │  │知识图谱   │  │  对话界面  │  │习题生成   │ │
│  │  组件    │  │  组件    │  │  组件    │  │  组件    │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/REST API
┌─────────────────────────────────────────────────────────────┐
│                        后端 API 层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │文档管理  │  │图谱查询   │  │ RAG 查询  │  │Agent 服务 │ │
│  │  路由    │  │  路由    │  │  路由    │  │  路由    │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              LightRAG 核心服务                        │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │文档处理  │  │知识图谱   │  │  查询检索  │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              多 Agent 服务                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │文档分析  │  │习题分析   │  │习题生成   │          │  │
│  │  │  Agent   │  │  Agent   │  │  Agent   │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  │  ┌──────────┐  ┌──────────┐                          │  │
│  │  │知识点匹配 │  │质量评估   │                          │  │
│  │  │  Agent   │  │  Agent   │                          │  │
│  │  └──────────┘  └──────────┘                          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │ KV 存储   │  │向量存储   │  │  图存储   │  │文件存储   │ │
│  │ (Redis/   │  │(Milvus/  │  │(Neo4j/   │  │(本地文件/ │ │
│  │  JSON)    │  │ Qdrant)  │  │NetworkX) │  │  对象存储) │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 模块划分（低耦合设计）

#### 3.2.1 后端模块划分

```
backend/
├── app/
│   ├── main.py                 # FastAPI 应用入口
│   ├── config.py               # 配置管理
│   ├── dependencies.py         # 依赖注入
│   │
│   ├── api/                    # API 路由
│   │   ├── documents.py        # 文档管理路由
│   │   ├── graph.py            # 图谱查询路由
│   │   ├── query.py            # RAG 查询路由
│   │   └── exercises.py        # 习题生成路由
│   │
│   ├── services/               # 业务逻辑服务
│   │   ├── document_service.py # 文档处理服务
│   │   ├── graph_service.py    # 图谱服务
│   │   ├── rag_service.py     # RAG 查询服务
│   │   └── agent_service.py   # Agent 服务
│   │
│   ├── agents/                 # Agent 实现
│   │   ├── base_agent.py       # Agent 基类
│   │   ├── document_analyzer.py # 文档分析 Agent
│   │   ├── exercise_analyzer.py # 习题分析 Agent
│   │   ├── knowledge_matcher.py # 知识点匹配 Agent
│   │   ├── exercise_generator.py # 习题生成 Agent
│   │   └── quality_evaluator.py  # 质量评估 Agent
│   │
│   ├── models/                 # 数据模型
│   │   ├── document.py         # 文档模型
│   │   ├── graph.py            # 图谱模型
│   │   ├── query.py            # 查询模型
│   │   └── exercise.py         # 习题模型
│   │
│   ├── utils/                  # 工具函数
│   │   ├── document_parser.py  # 文档解析工具
│   │   ├── lightrag_wrapper.py # LightRAG 封装
│   │   └── llm_client.py       # LLM 客户端封装
│   │
│   └── storage/                # 存储抽象层
│       ├── file_storage.py     # 文件存储接口
│       └── cache.py            # 缓存接口
│
├── requirements.txt            # Python 依赖
└── .env                        # 环境变量配置
```

#### 3.2.2 前端模块划分

```
frontend/
├── src/
│   ├── main.js                 # 应用入口
│   ├── App.vue                 # 根组件
│   │
│   ├── views/                  # 页面视图
│   │   ├── DocumentView.vue    # 文档管理页
│   │   ├── GraphView.vue       # 知识图谱页
│   │   ├── ChatView.vue        # 对话页
│   │   └── ExerciseView.vue   # 习题生成页
│   │
│   ├── components/             # 组件
│   │   ├── PPTViewer/          # PPT 查看器组件
│   │   │   ├── SlideViewer.vue
│   │   │   ├── ThumbnailList.vue
│   │   │   └── EntityHighlighter.vue
│   │   │
│   │   ├── GraphViewer/        # 图谱查看器组件
│   │   │   ├── GraphCanvas.vue
│   │   │   ├── NodeDetails.vue
│   │   │   └── GraphFilters.vue
│   │   │
│   │   ├── Chat/               # 对话组件
│   │   │   ├── ChatWindow.vue
│   │   │   ├── MessageList.vue
│   │   │   └── QueryInput.vue
│   │   │
│   │   └── Exercise/           # 习题组件
│   │       ├── ExerciseList.vue
│   │       ├── ExerciseCard.vue
│   │       └── GenerationConfig.vue
│   │
│   ├── services/               # API 服务
│   │   ├── api.js              # API 客户端
│   │   ├── documentService.js  # 文档服务
│   │   ├── graphService.js     # 图谱服务
│   │   ├── queryService.js     # 查询服务
│   │   └── exerciseService.js  # 习题服务
│   │
│   ├── stores/                 # 状态管理（Pinia/Vuex）
│   │   ├── documentStore.js
│   │   ├── graphStore.js
│   │   ├── queryStore.js
│   │   └── exerciseStore.js
│   │
│   └── utils/                  # 工具函数
│       ├── constants.js
│       └── helpers.js
│
├── package.json
└── vite.config.js              # 构建配置
```

### 3.3 核心服务设计

#### 3.3.1 DocumentService（文档处理服务）

**职责**: 封装 LightRAG 的文档处理功能

**接口**:
```python
class DocumentService:
    async def upload_documents(self, files: List[UploadFile]) -> str:
        """上传文档，返回 track_id"""
        
    async def get_processing_status(self, track_id: str) -> Dict:
        """获取处理状态"""
        
    async def get_document_slides(self, doc_id: str) -> List[Dict]:
        """获取文档幻灯片列表"""
        
    async def get_slide_content(self, doc_id: str, slide_id: str) -> Dict:
        """获取幻灯片内容"""
```

**依赖**:
- LightRAG 实例
- 文件存储服务
- 文档解析工具

#### 3.3.2 GraphService（图谱服务）

**职责**: 提供知识图谱查询和操作功能

**接口**:
```python
class GraphService:
    async def get_graph_data(
        self, 
        doc_ids: Optional[List[str]] = None,
        filters: Optional[Dict] = None
    ) -> Dict:
        """获取图谱数据"""
        
    async def get_entity_details(self, entity_id: str) -> Dict:
        """获取实体详情"""
        
    async def search_entities(self, query: str) -> List[Dict]:
        """搜索实体"""
```

**依赖**:
- LightRAG 实例（图存储）

#### 3.3.3 RAGService（RAG 查询服务）

**职责**: 封装 LightRAG 的查询功能

**接口**:
```python
class RAGService:
    async def query(
        self,
        query: str,
        mode: str = "mix",
        doc_ids: Optional[List[str]] = None,
        stream: bool = False
    ) -> Union[Dict, AsyncGenerator]:
        """执行查询"""
        
    async def get_context(
        self,
        query: str,
        mode: str = "mix"
    ) -> Dict:
        """仅获取上下文，不生成回答"""
```

**依赖**:
- LightRAG 实例

#### 3.3.4 AgentService（Agent 服务）

**职责**: 协调多个 Agent 完成习题生成任务

**接口**:
```python
class AgentService:
    async def start_generation_task(
        self,
        doc_ids: List[str],
        history_track_id: str,
        config: Dict
    ) -> str:
        """启动生成任务，返回 task_id"""
        
    async def get_task_status(self, task_id: str) -> Dict:
        """获取任务状态"""
        
    async def get_generation_results(self, task_id: str) -> Dict:
        """获取生成结果"""
```

**依赖**:
- 各个 Agent 实例
- LightRAG 实例
- 任务队列（可选，用于异步处理）

### 3.4 Agent 基类设计

为了保持 Agent 之间的低耦合，定义统一的 Agent 基类：

```python
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class BaseAgent(ABC):
    """Agent 基类"""
    
    def __init__(self, name: str, llm_client, config: Dict = None):
        self.name = name
        self.llm_client = llm_client
        self.config = config or {}
    
    @abstractmethod
    async def execute(self, input_data: Dict) -> Dict:
        """
        执行 Agent 任务
        
        Args:
            input_data: 输入数据
            
        Returns:
            输出数据
        """
        pass
    
    async def validate_input(self, input_data: Dict) -> bool:
        """验证输入数据"""
        return True
    
    async def handle_error(self, error: Exception) -> Dict:
        """错误处理"""
        return {"error": str(error), "agent": self.name}
```

各个 Agent 继承基类并实现 `execute` 方法：

```python
class DocumentAnalyzerAgent(BaseAgent):
    """文档分析 Agent"""
    
    async def execute(self, input_data: Dict) -> Dict:
        doc_ids = input_data["doc_ids"]
        # 使用 LightRAG 提取知识点
        # 使用 LLM 分析知识点结构
        # 返回知识点列表和层级关系
        pass

class ExerciseAnalyzerAgent(BaseAgent):
    """习题分析 Agent"""
    
    async def execute(self, input_data: Dict) -> Dict:
        history_files = input_data["files"]
        # 解析历史习题
        # 提取题型、难度、知识点
        # 返回分析结果
        pass
```

### 3.5 数据流设计

#### 3.5.1 文档处理数据流

```
用户上传文档
    ↓
DocumentService.upload_documents()
    ↓
保存文件到 uploads/
    ↓
调用 LightRAG.insert() 异步处理
    ↓
DocumentParser 解析文档（提取文本、幻灯片）
    ↓
LightRAG 分块、向量化、提取实体关系
    ↓
保存处理结果到存储
    ↓
返回 track_id，前端轮询状态
```

#### 3.5.2 查询数据流

```
用户提交查询
    ↓
RAGService.query()
    ↓
LightRAG.aquery()
    ↓
提取关键词 → 检索实体/关系/文本块 → 构建上下文 → LLM 生成回答
    ↓
返回回答和引用信息
    ↓
前端展示结果
```

#### 3.5.3 习题生成数据流

```
用户提交生成任务
    ↓
AgentService.start_generation_task()
    ↓
并行执行：
    ├─ DocumentAnalyzerAgent → 提取 PPT 知识点
    └─ ExerciseAnalyzerAgent → 分析历史习题
    ↓
KnowledgeMatcherAgent → 匹配知识点
    ↓
ExerciseGeneratorAgent → 生成习题（分批处理）
    ↓
QualityEvaluatorAgent → 评估质量
    ↓
保存结果，返回 task_id
    ↓
前端轮询获取结果
```

### 3.6 技术选型建议

#### 3.6.1 后端技术

- **Web 框架**: FastAPI（高性能、自动生成 API 文档）
- **异步处理**: asyncio（LightRAG 已支持）
- **任务队列**: Celery + Redis（可选，用于长时间运行的 Agent 任务）
- **文档解析**: 
  - PPTX: `python-pptx`
  - PPT: `python-pptx` + `comtypes`（Windows）或 `unoconv`（Linux）
  - PDF: `textract` 或 `PyPDF2` + `pdfplumber`
- **LLM 客户端**: 使用 LightRAG 内置的 LLM 集成

#### 3.6.2 前端技术

- **框架**: Vue.js 3 + Composition API 或 React 18
- **状态管理**: Pinia（Vue）或 Zustand（React）
- **HTTP 客户端**: Axios
- **图谱可视化**: 
  - D3.js（更灵活，需要更多开发）
  - Cytoscape.js（更适合图可视化，开箱即用）
- **UI 组件库**: Element Plus（Vue）或 Ant Design（React）

#### 3.6.3 存储方案

**开发环境**:
- 使用 LightRAG 默认的 JSON 文件存储

**生产环境**:
- **KV 存储**: Redis（缓存、会话）
- **向量存储**: Milvus 或 Qdrant（大规模向量检索）
- **图存储**: Neo4j（复杂图查询）或继续使用 NetworkX（小规模）
- **文件存储**: 本地文件系统或对象存储（MinIO/S3）

### 3.7 接口规范

#### 3.7.1 RESTful API 设计原则

- 使用标准 HTTP 方法（GET、POST、PUT、DELETE）
- 使用名词表示资源，动词表示操作
- 使用 HTTP 状态码表示结果
- 统一的响应格式

#### 3.7.2 统一响应格式

```json
{
    "code": 200,
    "message": "success",
    "data": {},
    "timestamp": "2024-01-01T00:00:00Z"
}
```

**错误响应**:
```json
{
    "code": 400,
    "message": "错误描述",
    "error": "详细错误信息",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 4. 实现流程

### 4.1 第一阶段：基础功能实现

**目标**: 实现文档上传、知识抽取、知识图谱可视化

1. **环境搭建**
   - 配置 LightRAG 环境（LLM、Embedding）
   - 搭建后端 FastAPI 服务
   - 搭建前端 Vue.js/React 应用

2. **文档处理模块**
   - 实现文档上传接口
   - 集成文档解析（PPTX/PPT/PDF）
   - 调用 LightRAG 进行知识抽取
   - 实现处理状态查询接口

3. **PPT 可视化模块**
   - 实现幻灯片列表接口
   - 实现幻灯片内容渲染组件
   - 实现实体标注功能

4. **知识图谱可视化模块**
   - 实现图谱数据查询接口
   - 集成图谱可视化库（D3.js/Cytoscape.js）
   - 实现图谱交互功能（节点详情、过滤等）

**时间估算**: 4-6 周

### 4.2 第二阶段：查询与对话功能

**目标**: 实现基于 LightRAG 的智能问答

1. **查询模块**
   - 实现查询接口（支持多种模式）
   - 实现流式查询接口
   - 实现引用展示功能

2. **对话界面**
   - 实现对话历史管理
   - 实现多轮对话支持
   - 实现流式输出展示

**时间估算**: 2-3 周

### 4.3 第三阶段：多 Agent 习题生成

**目标**: 实现多 Agent 架构的习题生成功能

1. **Agent 基础框架**
   - 实现 Agent 基类
   - 实现 Agent 协调服务
   - 实现任务队列（可选）

2. **文档分析 Agent**
   - 实现知识点提取
   - 实现知识点层级分析
   - 实现难度评估

3. **习题分析 Agent**
   - 实现历史习题解析
   - 实现题型识别
   - 实现知识点提取

4. **知识点匹配 Agent**
   - 实现向量相似度匹配
   - 实现语义匹配
   - 实现映射关系构建

5. **习题生成 Agent**
   - 实现习题生成逻辑
   - 实现题型适配
   - 实现难度控制

6. **质量评估 Agent**
   - 实现多维度评估
   - 实现质量评分

7. **前端界面**
   - 实现生成配置界面
   - 实现结果展示界面
   - 实现导出功能

**时间估算**: 6-8 周

### 4.4 第四阶段：优化与完善

**目标**: 性能优化、用户体验优化

1. **性能优化**
   - 查询性能优化（缓存、索引）
   - 图谱渲染性能优化（虚拟化、分页）
   - Agent 任务异步处理优化

2. **用户体验优化**
   - UI/UX 改进
   - 错误提示优化
   - 加载状态优化

3. **功能完善**
   - 添加批量操作
   - 添加数据导出功能
   - 添加用户权限管理（可选）

**时间估算**: 2-3 周

## 5. 技术难点与解决方案

### 5.1 PPT 文档解析

**难点**:
- PPT 格式复杂，包含文本、图片、表格、动画等
- PPT 旧格式（.ppt）兼容性问题

**解决方案**:
- 使用 `python-pptx` 处理 PPTX 格式
- 对于 PPT 格式，考虑转换为 PPTX 或使用 `comtypes`（Windows）调用 Office COM 接口
- 图片提取后上传到对象存储，前端通过 URL 访问
- 表格转换为 HTML 格式在前端渲染

### 5.2 大规模知识图谱可视化

**难点**:
- 节点和边数量多时，渲染性能差
- 布局算法计算量大

**解决方案**:
- 实现图谱分页/虚拟化（只渲染可见区域）
- 实现节点聚合（将相似节点合并）
- 使用 Web Worker 在后台计算布局
- 提供过滤功能减少节点数量
- 使用 Canvas 渲染而非 SVG（性能更好）

### 5.3 Agent 任务协调

**难点**:
- 多个 Agent 需要协调工作
- 任务执行时间长，需要异步处理
- 错误处理和重试机制

**解决方案**:
- 使用状态机管理任务状态
- 使用消息队列（Celery + Redis）处理长时间任务
- 实现任务检查点（checkpoint），支持断点续传
- 实现完善的错误处理和日志记录
- 提供任务取消功能

### 5.4 习题生成质量控制

**难点**:
- 生成的习题质量不稳定
- 难度匹配不准确
- 与历史习题相似度控制困难

**解决方案**:
- 使用多轮生成 + 质量评估筛选
- 使用 Few-Shot Learning，提供历史习题作为示例
- 实现相似度检测，过滤过于相似的题目
- 允许用户反馈，持续优化生成策略

## 6. 部署方案

### 6.1 开发环境部署

```bash
# 后端
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000

# 前端
cd frontend
npm install
npm run dev
```

### 6.2 生产环境部署

**使用 Docker Compose**:

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/data:/app/data
    environment:
      - LLM_BINDING=openai
      - LLM_MODEL=gpt-4o-mini
      - LLM_BINDING_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - redis
      - milvus

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  milvus:
    image: milvusdb/milvus:latest
    volumes:
      - milvus_data:/var/lib/milvus
```

**使用 Kubernetes**:

- 将各个服务容器化
- 使用 Deployment 管理服务
- 使用 Service 暴露服务
- 使用 ConfigMap 和 Secret 管理配置

## 7. 测试计划

### 7.1 单元测试

- 文档解析函数测试
- Agent 逻辑测试
- API 路由测试

### 7.2 集成测试

- 文档处理流程测试
- 查询流程测试
- Agent 协作测试

### 7.3 性能测试

- 并发上传测试
- 大规模图谱渲染测试
- 查询响应时间测试

## 8. 后续扩展方向

1. **多用户支持**: 添加用户系统，支持多租户
2. **协作功能**: 支持多人协作标注和编辑
3. **移动端适配**: 开发移动端应用
4. **插件系统**: 支持自定义 Agent 和可视化插件
5. **数据分析**: 添加学习数据分析功能（知识点掌握度、学习路径推荐等）

